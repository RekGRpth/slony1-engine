#!/bin/sh
# ----------------------------------------------------------------------
# slony1_schema.sh.in
#
#	Shell script to load the base schema and support functions
#	for a Slony-I cluster into a database.
#
# $Id: slony1_schema.sh.in,v 1.3 2003-12-03 19:07:29 wieck Exp $
# ----------------------------------------------------------------------


# ----
# Check call syntax
# ----
if [ $# -ne 2 ] ; then
	echo "usage: `basename $0` dbname clustername" >&2
	echo "" >&2
	echo "    Load the schema and support functions into <dbname>" >&2
	echo "    under namespace \"_<clustername>\"." >&2
	echo "" >&2
	exit 1
fi

dbname=$1
namespace="_$2"
clustername="$2"
libdir=@LIBDIR@

# ----
# Determine the database version
# ----
version_str=`psql -Aqt -c "select version()" $dbname`
if [ $? -ne 0 ] ; then
	echo "abort"
	exit -1
fi
version=`echo $version_str | sed -e 's/^PostgreSQL \([^ ]*\).*/\1/'`

case $version in
	7.3|7.3.*)	base_version=7.3
				xfiles=v73
				bfiles=v73
				;;
	7.4|7.4.*)	base_version=7.4
				xfiles=v73
				bfiles=v73
				;;
	*)			echo "Unsupported database version $version" >&2
				exit 2
				;;
esac

#
# Check that the namespace doesn't exist yet
#
exists=`psql -Aqt -c "select nspname from pg_namespace where nspname = '${namespace}';" $dbname`
if [ "x${exists}" = "x${namespace}" ] ; then
	echo "Namespace \"$namespace\" already exists" >&2
	exit 2
fi


echo "PostgreSQL version is $version"
echo "Using database verion specific xfiles $xfiles"
echo "Using database verion specific bfiles $bfiles"
echo "Namespace is \"$namespace\""
echo ""

case $base_version in
	7.3|7.4)	(
					echo "create schema \"${namespace}\";"

					cat ${libdir}/xxid.$xfiles.sql						\
						${libdir}/slony1_base.sql						\
						${libdir}/slony1_base.$bfiles.sql				\
						${libdir}/slony1_funcs.sql						\
						${libdir}/slony1_funcs.$bfiles.sql				\
						| sed -e "s/@CLUSTERNAME@/${clustername}/g"		\
							  -e "s/@NAMESPACE@/\\\"${namespace}\\\"/g"	\
				) | psql -e $dbname 2>&1 | grep "^ERROR"
				;;
esac

