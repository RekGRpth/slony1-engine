#
# slony1_common.sh.in
#


#
# Source in the current cluster information if it exists
#
CLUSTER_INFO=@LIBDIR@/ducttape_cluster_info-$SLONY1_CLUSTERNAME
if [ -f $CLUSTER_INFO ] ; then
	. $CLUSTER_INFO
	NewCluster=0
else
	NewCluster=1
fi
export CLUSTER_INFO


#
# get_conninfo no_id
#
function get_conninfo () {
	eval echo "\${ConnInfo_$1}"
}

#
# get_conninfo_src no_id
#
function get_conninfo_src () {
	err=0

	conninfo=`get_conninfo $1`
	if [ -z "$conninfo" ] ; then
		echo "unknown node id $1" >&2
		return 1
	fi

	for part in `get_conninfo $1` ; do
		key=`echo $part | sed -e 's/=.*//'`
		val=`echo $part | sed -e 's/[^=]*=//'`
		case $key in
			dbname)		echo "DBNAME=$val"
						echo "export DBNAME"
						;;
			host)		echo "PGHOST=$val"
						echo "export PGHOST"
						;;
			port)		echo "PGPORT=$val"
						echo "export PGPORT"
						;;
			*)			echo "unknown conninfo part $val" >&2
						err=1
						;;
		esac
	done

	return $err
}


#
# get_postgres_version no_id
#
function get_postgres_version () {
	src=`get_conninfo_src $1` || return 1
	eval $src

	vstr=`psql -Aqt -c "select version();" $DBNAME` || return 1
	echo $vstr | sed -e 's/^PostgreSQL \([^ ]*\).*/\1/'
	return 0
}


