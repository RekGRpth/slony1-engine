<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Database Schema Changes (DDL)</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:cbbrowne@gmail.com"><LINK
REL="HOME"
TITLE="Slony-I 1.1 Administration"
HREF="slony.html"><LINK
REL="UP"
HREF="slonyadmin.html"><LINK
REL="PREVIOUS"
TITLE=" Dropping things from Slony Replication"
HREF="dropthings.html"><LINK
REL="NEXT"
TITLE="Replicating Your First Database"
HREF="firstdb.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stdstyle.css"><META
HTTP-EQUIV="Content-Type"></HEAD
><BODY
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Slony-I 1.1 Administration</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="dropthings.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="firstdb.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="DDLCHANGES"
>11. Database Schema Changes (DDL)</A
></H1
><P
>When changes are made to the database schema, <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>e.g.</I
></SPAN
> -
adding fields to a table, it is necessary for this to be handled
rather carefully, otherwise different nodes may get rather deranged
because they disagree on how particular tables are built.&#13;</P
><P
>If you pass the changes through Slony-I via the <TT
CLASS="COMMAND"
>EXECUTE
SCRIPT</TT
> (slonik) / <CODE
CLASS="FUNCTION"
>ddlscript(set,script,node)</CODE
> (stored
function), this allows you to be certain that the changes take effect
at the same point in the transaction streams on all of the nodes.
That may not be too important if you can take something of an outage
to do schema changes, but if you want to do upgrades that take place
while transactions are still firing their way through your systems,
it's necessary.&#13;</P
><P
>It's worth making a couple of comments on <SPAN
CLASS="QUOTE"
>"special things"</SPAN
>
about <TT
CLASS="COMMAND"
>EXECUTE SCRIPT</TT
>:

<P
></P
><UL
><LI
><P
> The script must not contain transaction
<TT
CLASS="COMMAND"
>BEGIN</TT
> or <TT
CLASS="COMMAND"
>END</TT
> statements, as the script is already
executed inside a transaction.  In PostgreSQL version 8, the
introduction of nested transactions may change this requirement
somewhat, but you must still remain aware that the actions in the
script are wrapped inside a transaction.&#13;</P
></LI
><LI
><P
> If there is <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>anything</I
></SPAN
> broken about the
script, or about how it executes on a particular node, this will cause
the slon daemon for that node to panic and crash. If you restart the
node, it will, more likely than not, try to <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>repeat</I
></SPAN
> the DDL
script, which will, almost certainly, fail the second time just as it
did the first time.  I have found this scenario to lead to a need to
go to the <SPAN
CLASS="QUOTE"
>"master"</SPAN
> node to delete the event to stop it from
continuing to fail.&#13;</P
></LI
><LI
><P
> For slon to, at that point, <SPAN
CLASS="QUOTE"
>"panic"</SPAN
> is probably
the <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>correct</I
></SPAN
> answer, as it allows the DBA to head over to
the database node that is broken, and manually fix things before
cleaning out the defective event and restarting slon.  You can be
certain that the updates made <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>after</I
></SPAN
> the DDL change on the
provider node are queued up, waiting to head to the subscriber.  You
don't run the risk of there being updates made that depended on the
DDL changes in order to be correct.&#13;</P
></LI
></UL
>&#13;</P
><P
>Unfortunately, this nonetheless implies that the use of the DDL
facility is somewhat fragile and dangerous.  Making DDL changes should
not be done in a sloppy or cavalier manner.  If your applications do
not have fairly stable SQL schemas, then using Slony-I for replication
is likely to be fraught with trouble and frustration.&#13;</P
><P
>There is an article on how to manage Slony schema changes here:
<A
HREF="http://www.varlena.com/varlena/GeneralBits/88.php"
TARGET="_top"
>Varlena General Bits</A
>


 </P
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="dropthings.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="slony.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="firstdb.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Dropping things from Slony Replication</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="slonyadmin.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Replicating Your First Database</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>