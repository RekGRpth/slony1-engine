<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
> Slony-I Administration Scripts</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REV="MADE"
HREF="mailto:cbbrowne@gmail.com"><LINK
REL="HOME"
TITLE="Slony-I 1.1 Administration"
HREF="slony.html"><LINK
REL="UP"
HREF="t24.html"><LINK
REL="PREVIOUS"
TITLE="Defining Slony-I Replication Sets"
HREF="x267.html"><LINK
REL="NEXT"
TITLE="Slon daemons"
HREF="slonstart.html"><LINK
REL="STYLESHEET"
TYPE="text/css"
HREF="stdstyle.css"><META
HTTP-EQUIV="Content-Type"></HEAD
><BODY
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>Slony-I 1.1 Administration</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="x267.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="slonstart.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="ALTPERL"
>8. Slony-I Administration Scripts</A
></H1
><P
>In the "altperl" directory in the CVS tree, there is a sizable set of Perl scripts that may be used to administer a set of Slony-I instances, which support having arbitrary numbers of nodes.&#13;</P
><P
>Most of them generate Slonik scripts that are then to be passed on to the slonik utility to be submitted to all of the Slony-I nodes in a particular cluster.  At one time, this embedded running slonik on the slonik scripts.  Unfortunately, this turned out to be a pretty large calibre "foot gun," as minor typos on the command line led, on a couple of occasions, to pretty calamitous actions, so the behaviour has been changed so that the scripts simply submit output to standard output.  An administrator should review the slonik script before submitting it to Slonik.&#13;</P
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN314"
>8.1. Node/Cluster Configuration - cluster.nodes</A
></H2
><P
>The UNIX environment variable <CODE
CLASS="ENVAR"
>SLONYNODES</CODE
> is used to determine what Perl configuration file will be used to control the shape of the nodes in a Slony-I cluster.&#13;</P
><P
>What variables are set up...
<P
></P
><UL
><LI
><P
> <CODE
CLASS="ENVAR"
>$SETNAME</CODE
>=orglogs;	# What is the name of the replication set?&#13;</P
></LI
><LI
><P
> <CODE
CLASS="ENVAR"
>$LOGDIR</CODE
>='/opt/OXRS/log/LOGDBS';  # What is the base directory for logs?&#13;</P
></LI
><LI
><P
> <CODE
CLASS="ENVAR"
>$SLON_BIN_PATH</CODE
>='/opt/dbs/pgsql74/bin';  # Where to look for slony binaries&#13;</P
></LI
><LI
><P
> <CODE
CLASS="ENVAR"
>$APACHE_ROTATOR</CODE
>="/opt/twcsds004/OXRS/apache/rotatelogs";  # If set, where to find Apache log rotator</P
></LI
></UL
>&#13;</P
><P
>You then define the set of nodes that are to be replicated using a set of calls to <CODE
CLASS="FUNCTION"
>add_node()</CODE
>.</P
><P
><TT
CLASS="COMMAND"
>  add_node (host =&#62; '10.20.30.40', dbname =&#62; 'orglogs', port =&#62; 5437,
			  user =&#62; 'postgres', node =&#62; 4, parent =&#62; 1);</TT
></P
><P
>The set of parameters for <CODE
CLASS="FUNCTION"
>add_node()</CODE
> are thus:&#13;</P
><P
> <P
CLASS="LITERALLAYOUT"
><TT
CLASS="LITERAL"
>my %PARAMS =   (host=&#62; undef,		# Host name
	   	dbname =&#62; 'template1',	# database name
		port =&#62; 5432,		# Port number
		user =&#62; 'postgres',	# user to connect as
		node =&#62; undef,		# node number
		password =&#62; undef,	# password for user
		parent =&#62; 1,		# which node is parent to this node
		noforward =&#62; undef	# shall this node be set up to forward results?
);</TT
></P
></P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN342"
>8.2. Set configuration - cluster.set1, cluster.set2</A
></H2
><P
>The UNIX environment variable <CODE
CLASS="ENVAR"
>SLONYSET</CODE
> is used to determine what Perl configuration file will be used to determine what objects will be contained in a particular replication set.&#13;</P
><P
>Unlike <CODE
CLASS="ENVAR"
>SLONYNODES</CODE
>, which is essential for <SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>all</I
></SPAN
> of the slonik-generating scripts, this only needs to be set when running <TT
CLASS="FILENAME"
>create_set.pl</TT
>, as that is the only script used to control what tables will be in a particular replication set.&#13;</P
><P
>What variables are set up...
<P
></P
><UL
><LI
><P
> $TABLE_ID = 44;	 Each table must be identified by a unique number; this variable controls where numbering starts</P
></LI
><LI
><P
> @PKEYEDTABLES		An array of names of tables to be replicated that have a defined primary key so that Slony-I can automatically select its key</P
></LI
><LI
><P
> %KEYEDTABLES		 A hash table of tables to be replicated, where the hash index is the table name, and the hash value is the name of a unique not null index suitable as a "candidate primary key."</P
></LI
><LI
><P
> @SERIALTABLES		An array of names of tables to be replicated that have no candidate for primary key.  Slony-I will add a key field based on a sequence that Slony-I generates</P
></LI
><LI
><P
> @SEQUENCES			An array of names of sequences that are to be replicated</P
></LI
></UL
>&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN362"
>8.3. build_env.pl</A
></H2
><P
>Queries a database, generating output hopefully suitable for
<TT
CLASS="FILENAME"
>slon.env</TT
> consisting of:
<P
></P
><UL
><LI
><P
> a set of <CODE
CLASS="FUNCTION"
>add_node()</CODE
> calls to configure the cluster</P
></LI
><LI
><P
> The arrays <CODE
CLASS="ENVAR"
>@KEYEDTABLES</CODE
>, <CODE
CLASS="ENVAR"
>@SERIALTABLES</CODE
>, and <CODE
CLASS="ENVAR"
>@SEQUENCES</CODE
></P
></LI
></UL
>&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN375"
>8.4. create_set.pl</A
></H2
><P
>This requires <CODE
CLASS="ENVAR"
>SLONYSET</CODE
> to be set as well as <CODE
CLASS="ENVAR"
>SLONYNODES</CODE
>; it is used to
generate the Slonik script to set up a replication set consisting of a
set of tables and sequences that are to be replicated.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN380"
>8.5. drop_node.pl</A
></H2
><P
>Generates Slonik script to drop a node from a Slony-I cluster.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN383"
>8.6. drop_set.pl</A
></H2
><P
>Generates Slonik script to drop a replication set (<SPAN
CLASS="emphasis"
><I
CLASS="EMPHASIS"
>e.g.</I
></SPAN
> - set of tables and sequences) from a Slony-I cluster.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN387"
>8.7. failover.pl</A
></H2
><P
>Generates Slonik script to request failover from a dead node to some new origin&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN390"
>8.8. init_cluster.pl</A
></H2
><P
>Generates Slonik script to initialize a whole Slony-I cluster,
including setting up the nodes, communications paths, and the listener
routing.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN393"
>8.9. merge_sets.pl</A
></H2
><P
>Generates Slonik script to merge two replication sets together.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN396"
>8.10. move_set.pl</A
></H2
><P
>Generates Slonik script to move the origin of a particular set to a different node.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN399"
>8.11. replication_test.pl</A
></H2
><P
>Script to test whether Slony-I is successfully replicating data.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN402"
>8.12. restart_node.pl</A
></H2
><P
>Generates Slonik script to request the restart of a node.  This was
particularly useful pre-1.0.5 when nodes could get snarled up when
slon daemons died.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN405"
>8.13. restart_nodes.pl</A
></H2
><P
>Generates Slonik script to restart all nodes in the cluster.  Not
particularly useful...&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN408"
>8.14. show_configuration.pl</A
></H2
><P
>Displays an overview of how the environment (e.g. - <CODE
CLASS="ENVAR"
>SLONYNODES</CODE
>) is set
to configure things.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN412"
>8.15. slon_kill.pl</A
></H2
><P
>Kills slony watchdog and all slon daemons for the specified set.  It
only works if those processes are running on the local host, of
course!&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN415"
>8.16. slon_pushsql.pl</A
></H2
><P
>Generates Slonik script to push DDL changes to a replication set.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN418"
>8.17. slon_start.pl</A
></H2
><P
>This starts a slon daemon for the specified cluster and node, and uses
slon_watchdog.pl to keep it running.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN421"
>8.18. slon_watchdog.pl</A
></H2
><P
>Used by slon_start.pl...&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN424"
>8.19. slon_watchdog2.pl</A
></H2
><P
>This is a somewhat smarter watchdog; it monitors a particular Slony-I
node, and restarts the slon process if it hasn't seen updates go in in
20 minutes or more.&#13;</P
><P
>This is helpful if there is an unreliable network connection such that
the slon sometimes stops working without becoming aware of it...&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN428"
>8.20. subscribe_set.pl</A
></H2
><P
>Generates Slonik script to subscribe a particular node to a particular replication set.&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN431"
>8.21. uninstall_nodes.pl</A
></H2
><P
>This goes through and drops the Slony-I schema from each node; use
this if you want to destroy replication throughout a cluster.  This is
a VERY unsafe script!&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN434"
>8.22. unsubscribe_set.pl</A
></H2
><P
>Generates Slonik script to unsubscribe a node from a replication set.
&#13;</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN437"
>8.23. update_nodes.pl</A
></H2
><P
>Generates Slonik script to tell all the nodes to update the Slony-I

functions.  This will typically be needed when you upgrade from one

version of Slony-I to another.


 </P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="x267.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="slony.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="slonstart.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Defining Slony-I Replication Sets</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="t24.html"
ACCESSKEY="U"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Slon daemons</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>